import React, { useState, useEffect } from 'react';
import { Job, JobStatus, WorkerType, PricingType, PaymentStatus, ServiceType, Settings, RecurrenceType } from '../types';
import { generateGoogleCalendarLink } from '../utils/calendar';
import { GoogleGenAI, Type } from "@google/genai";

interface Props {
  jobs: Job[];
  settings: Settings;
  onAddJob: (job: Job) => void;
  onDeleteJob: (id: string) => void;
  onUpdateStatus: (id: string, status: JobStatus) => void;
  onUpdatePayment: (id: string, status: PaymentStatus) => void;
  onUpdateSync: (id: string) => void;
  onAddCustomTask: (task: string) => void;
  onAddEmployee: (name: string) => void;
}

const DEFAULT_TASKS = [
  'Corte de relva',
  'Poda de ﾃ｡rvores/arbustos',
  'Limpeza de canteiros',
  'Fertilizaﾃｧﾃ｣o',
  'Tratamento fitossanitﾃ｡rio',
  'Manutenﾃｧﾃ｣o de rega',
  'Plantaﾃｧﾃ｣o',
  'Remoﾃｧﾃ｣o de resﾃｭduos'
];

const JobLog: React.FC<Props> = ({ 
  jobs, settings, onAddJob, onDeleteJob, onUpdateStatus, onUpdatePayment, onUpdateSync, onAddCustomTask, onAddEmployee 
}) => {
  const [showForm, setShowForm] = useState(false);
  const [timerActive, setTimerActive] = useState(false);
  const [timerStart, setTimerStart] = useState<number | null>(null);
  const [elapsedTime, setElapsedTime] = useState(0);
  
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState<JobStatus | 'all'>('all');
  const [serviceTypeFilter, setServiceTypeFilter] = useState<ServiceType | 'all'>('all');
  const [paymentFilter, setPaymentFilter] = useState<PaymentStatus | 'all'>('all');

  const [isOptimizing, setIsOptimizing] = useState(false);
  const [optimizedRoute, setOptimizedRoute] = useState<{order: string[], explanation: string} | null>(null);

  const [formData, setFormData] = useState({
    clientName: '',
    category: '',
    date: new Date().toISOString().split('T')[0],
    startTime: '09:00',
    endTime: '11:00',
    tasks: [] as string[],
    rate: 20,
    pricingType: 'hourly' as PricingType,
    workerType: 'alone' as WorkerType,
    workerNames: [] as string[],
    additionalWorkers: '', // Novo campo para colaboradores manuais
    status: 'scheduled' as JobStatus,
    paymentStatus: 'unpaid' as PaymentStatus,
    serviceType: 'regular' as ServiceType,
    recurrence: 'none' as RecurrenceType,
    notes: '',
    location: undefined as { lat: number, lng: number } | undefined
  });

  const [newTaskInput, setNewTaskInput] = useState('');
  const [newEmployeeInput, setNewEmployeeInput] = useState('');

  const allTasks = Array.from(new Set([...DEFAULT_TASKS, ...settings.customTasks]));
  const uniqueClients = Array.from(new Set(jobs.map(j => j.clientName))).sort();
  const allCategories = Array.from(new Set([...(settings.categories || []), "Relva", "Poda", "Rega", "Limpeza", "Plantaﾃｧﾃ｣o"])).sort();

  useEffect(() => {
    let interval: number;
    if (timerActive) {
      interval = window.setInterval(() => {
        if (timerStart) {
          setElapsedTime(Math.floor((Date.now() - timerStart) / 1000));
        }
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [timerActive, timerStart]);

  const handleGetLocation = () => {
    if (!navigator.geolocation) {
      alert("Geolocalizaﾃｧﾃ｣o nﾃ｣o ﾃｩ suportada pelo seu navegador.");
      return;
    }
    navigator.geolocation.getCurrentPosition((pos) => {
      setFormData(prev => ({
        ...prev,
        location: { lat: pos.coords.latitude, lng: pos.coords.longitude }
      }));
    }, (err) => {
      alert("Erro ao obter localizaﾃｧﾃ｣o: " + err.message);
    });
  };

  const handleOptimizeRoute = async () => {
    const today = new Date().toISOString().split('T')[0];
    const todayJobs = jobs.filter(j => j.date === today && j.status === 'scheduled' && j.location);

    if (todayJobs.length < 2) {
      alert("Sﾃ｣o necessﾃ｡rios pelo menos 2 serviﾃｧos agendados com localizaﾃｧﾃ｣o para otimizar a rota.");
      return;
    }

    setIsOptimizing(true);
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
    
    const locationsContext = todayJobs.map(j => ({
      id: j.id,
      client: j.clientName,
      lat: j.location!.lat,
      lng: j.location!.lng
    }));

    const prompt = `
      Como um especialista em logﾃｭstica, otimize a rota de trabalho para hoje.
      Abaixo estﾃ｣o os clientes e suas coordenadas (Latitude e Longitude):
      ${JSON.stringify(locationsContext)}

      Forneﾃｧa a ordem ideal de visita para minimizar o tempo de deslocaﾃｧﾃ｣o entre eles.
    `;

    try {
      const response = await ai.models.generateContent({
        model: 'gemini-3-pro-preview',
        contents: prompt,
        config: { 
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.OBJECT,
            properties: {
              order: {
                type: Type.ARRAY,
                items: { type: Type.STRING },
                description: 'The IDs of the jobs in the optimized order.'
              },
              explanation: {
                type: Type.STRING,
                description: 'Brief explanation of the route efficiency.'
              }
            },
            required: ["order", "explanation"]
          },
          thinkingConfig: { thinkingBudget: 4000 }
        }
      });
      
      const text = response.text;
      if (text) {
        const result = JSON.parse(text);
        setOptimizedRoute(result);
      }
    } catch (error) {
      console.error("Erro na otimizaﾃｧﾃ｣o:", error);
      alert("Nﾃ｣o foi possﾃｭvel otimizar a rota neste momento.");
    } finally {
      setIsOptimizing(false);
    }
  };

  const toggleTask = (task: string) => {
    setFormData(prev => ({
      ...prev,
      tasks: prev.tasks.includes(task) ? prev.tasks.filter(t => t !== task) : [...prev.tasks, task]
    }));
  };

  const handleAddNewTask = () => {
    if (newTaskInput.trim()) {
      onAddCustomTask(newTaskInput.trim());
      setNewTaskInput('');
    }
  };

  const handleAddNewEmployee = () => {
    if (newEmployeeInput.trim()) {
      onAddEmployee(newEmployeeInput.trim());
      setNewEmployeeInput('');
    }
  };

  const toggleWorker = (name: string) => {
    setFormData(prev => ({
      ...prev,
      workerNames: prev.workerNames.includes(name) ? prev.workerNames.filter(n => n !== name) : [...prev.workerNames, name]
    }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    let totalValue = 0;
    if (formData.pricingType === 'hourly') {
      const start = new Date(`${formData.date}T${formData.startTime}`);
      const end = new Date(`${formData.date}T${formData.endTime}`);
      const diffHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
      totalValue = Math.max(0, diffHours * formData.rate);
    } else {
      totalValue = formData.rate;
    }

    const baseId = Date.now();
    const recurrenceCount = formData.recurrence === 'weekly' ? 12 : formData.recurrence === 'biweekly' ? 6 : formData.recurrence === 'monthly' ? 6 : 1;
    const daysInterval = formData.recurrence === 'weekly' ? 7 : formData.recurrence === 'biweekly' ? 14 : formData.recurrence === 'monthly' ? 30 : 0;

    let firstJob: Job | null = null;

    // Combinar workers selecionados com workers inseridos manualmente
    const finalWorkers = [...formData.workerNames];
    if (formData.additionalWorkers.trim()) {
      finalWorkers.push(...formData.additionalWorkers.split(',').map(s => s.trim()));
    }

    for (let i = 0; i < recurrenceCount; i++) {
      const nextDate = new Date(formData.date);
      if (formData.recurrence === 'monthly') {
        nextDate.setMonth(nextDate.getMonth() + i);
      } else {
        nextDate.setDate(nextDate.getDate() + (i * daysInterval));
      }

      const newJob: Job = {
        ...formData,
        id: (baseId + i).toString(),
        date: nextDate.toISOString().split('T')[0],
        totalValue,
        workerNames: finalWorkers,
        syncedToCalendar: false
      };
      
      if (i === 0) firstJob = newJob;
      onAddJob(newJob);
    }

    if (settings.autoSyncCalendar && firstJob) {
      const url = generateGoogleCalendarLink(firstJob);
      window.open(url, '_blank');
      onUpdateSync(firstJob.id);
    }

    setShowForm(false);
    setTimerActive(false);
    setElapsedTime(0);
    setFormData({ 
      ...formData, 
      clientName: '', 
      category: '',
      tasks: [], 
      workerNames: [], 
      additionalWorkers: '',
      status: 'scheduled', 
      paymentStatus: 'unpaid', 
      serviceType: 'regular',
      recurrence: 'none',
      notes: '',
      location: undefined
    });
  };

  const handleStartTimer = () => {
    const now = new Date();
    setTimerStart(Date.now());
    setTimerActive(true);
    setFormData(prev => ({ ...prev, startTime: now.toTimeString().slice(0, 5), date: now.toISOString().split('T')[0], status: 'pending' }));
    setShowForm(true);
  };

  const filteredJobs = jobs.filter(job => {
    const matchesSearch = job.clientName.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesStatus = statusFilter === 'all' || job.status === statusFilter;
    const matchesService = serviceTypeFilter === 'all' || job.serviceType === serviceTypeFilter;
    const matchesPayment = paymentFilter === 'all' || job.paymentStatus === paymentFilter;
    
    return matchesSearch && matchesStatus && matchesService && matchesPayment;
  });

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
        <h2 className="text-xl font-bold text-slate-800">Agenda e Registos</h2>
        <div className="flex gap-2">
          {!timerActive ? (
            <button onClick={handleStartTimer} className="bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-xl transition shadow-md font-bold text-sm">
              <i className="fas fa-play mr-2"></i> Cronﾃｳmetro
            </button>
          ) : (
            <div className="flex items-center bg-white border border-rose-200 px-4 py-2 rounded-xl shadow-sm gap-4">
              <span className="text-rose-600 font-mono font-bold animate-pulse">{(elapsedTime / 3600).toFixed(0).padStart(2,'0')}:{((elapsedTime % 3600)/60).toFixed(0).padStart(2,'0')}</span>
              <button onClick={() => setTimerActive(false)} className="text-rose-600 font-bold">Parar</button>
            </div>
          )}
          <button onClick={() => setShowForm(!showForm)} className="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm">
            {showForm ? 'Fechar' : '+ Novo Serviﾃｧo'}
          </button>
        </div>
      </div>

      {showForm && (
        <form onSubmit={handleSubmit} className="bg-white p-6 rounded-2xl shadow-md border border-slate-100 space-y-6 animate-in fade-in zoom-in duration-300">
          <datalist id="clients-list">
            {uniqueClients.map(c => <option key={c} value={c} />)}
          </datalist>
          <datalist id="categories-list">
            {allCategories.map(c => <option key={c} value={c} />)}
          </datalist>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="space-y-1 lg:col-span-1">
              <label className="text-xs font-bold text-slate-500 uppercase">Cliente</label>
              <div className="flex gap-2">
                <input required list="clients-list" className="flex-1 border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value={formData.clientName} onChange={e => setFormData({ ...formData, clientName: e.target.value })} />
                <button type="button" onClick={handleGetLocation} title="Obter Localizaﾃｧﾃ｣o" className={`px-3 rounded-lg border text-xs font-bold transition ${formData.location ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}>
                  <i className="fas fa-map-marker-alt"></i>
                </button>
              </div>
            </div>
            <div className="space-y-1">
              <label className="text-xs font-bold text-slate-500 uppercase">Categoria</label>
              <input 
                required 
                list="categories-list" 
                className="w-full border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" 
                placeholder="Ex: Relva, Poda..."
                value={formData.category} 
                onChange={e => setFormData({ ...formData, category: e.target.value })} 
              />
            </div>
            <div className="space-y-1">
              <label className="text-xs font-bold text-slate-500 uppercase">Data de Inﾃｭcio</label>
              <input type="date" required className="w-full border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value={formData.date} onChange={e => setFormData({ ...formData, date: e.target.value })} />
            </div>
            <div className="grid grid-cols-2 gap-2">
              <div className="space-y-1">
                <label className="text-xs font-bold text-slate-500 uppercase">Inﾃｭcio</label>
                <input type="time" required className="w-full border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value={formData.startTime} onChange={e => setFormData({ ...formData, startTime: e.target.value })} />
              </div>
              <div className="space-y-1">
                <label className="text-xs font-bold text-slate-500 uppercase">Fim</label>
                <input type="time" required className="w-full border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value={formData.endTime} onChange={e => setFormData({ ...formData, endTime: e.target.value })} />
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 border-t border-slate-50 pt-4">
            <div className="space-y-1">
              <label className="text-xs font-bold text-slate-500 uppercase">Tipo de Serviﾃｧo</label>
              <div className="flex bg-slate-100 p-1 rounded-lg">
                <button type="button" onClick={() => setFormData({...formData, serviceType: 'regular'})} className={`flex-1 py-1.5 rounded-md text-[10px] font-bold transition-all ${formData.serviceType === 'regular' ? 'bg-white shadow text-emerald-600' : 'text-slate-500'}`}>MANUTENﾃﾃグ</button>
                <button type="button" onClick={() => setFormData({...formData, serviceType: 'extra'})} className={`flex-1 py-1.5 rounded-md text-[10px] font-bold transition-all ${formData.serviceType === 'extra' ? 'bg-white shadow text-amber-600' : 'text-slate-500'}`}>EXTRA</button>
              </div>
            </div>
            <div className="space-y-1">
              <label className="text-xs font-bold text-slate-500 uppercase">Repetiﾃｧﾃ｣o</label>
              <select className="w-full border border-slate-200 rounded-lg p-2 text-sm" value={formData.recurrence} onChange={e => setFormData({...formData, recurrence: e.target.value as RecurrenceType})}>
                <option value="none">Nﾃ｣o repetir</option>
                <option value="weekly">Semanal (12 sem.)</option>
                <option value="biweekly">Quinzenal (6x)</option>
                <option value="monthly">Mensal (6 meses)</option>
              </select>
            </div>
            <div className="space-y-1">
              <label className="text-xs font-bold text-slate-500 uppercase">Estado Pagamento</label>
              <select className="w-full border border-slate-200 rounded-lg p-2 text-sm" value={formData.paymentStatus} onChange={e => setFormData({...formData, paymentStatus: e.target.value as PaymentStatus})}>
                <option value="unpaid">Em Dﾃｭvida</option>
                <option value="paid">Pago</option>
              </select>
            </div>
            <div className="space-y-1">
              <label className="text-xs font-bold text-slate-500 uppercase">Estado do Job</label>
              <select className="w-full border border-slate-200 rounded-lg p-2 text-sm" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value as JobStatus})}>
                <option value="scheduled">Agendado</option>
                <option value="pending">Pendente</option>
                <option value="completed">Concluﾃｭdo</option>
              </select>
            </div>
          </div>

          <div className="space-y-3 border-t border-slate-50 pt-4">
            <div className="flex justify-between items-center">
              <label className="text-xs font-bold text-slate-500 uppercase">Checklist de Tarefas</label>
              <div className="flex gap-2">
                <input placeholder="Nova tarefa..." className="text-xs border border-slate-200 rounded px-2 py-1" value={newTaskInput} onChange={e => setNewTaskInput(e.target.value)} />
                <button type="button" onClick={handleAddNewTask} className="text-xs bg-slate-100 px-2 rounded hover:bg-slate-200 transition">+</button>
              </div>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
              {allTasks.map(task => (
                <button key={task} type="button" onClick={() => toggleTask(task)} className={`text-[10px] p-2 rounded-lg border transition text-left ${formData.tasks.includes(task) ? 'bg-emerald-100 border-emerald-500 text-emerald-800 font-bold' : 'bg-slate-50 border-slate-200 text-slate-500'}`}>
                  {task}
                </button>
              ))}
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4">
            <div className="space-y-4">
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <label className="text-xs font-bold text-slate-500 uppercase">Equipa (Sugeridos)</label>
                  <div className="flex gap-2">
                    <input placeholder="Novo funcionﾃ｡rio..." className="text-xs border border-slate-200 rounded px-2 py-1" value={newEmployeeInput} onChange={e => setNewEmployeeInput(e.target.value)} />
                    <button type="button" onClick={handleAddNewEmployee} className="text-xs bg-slate-100 px-2 rounded hover:bg-slate-200 transition">+</button>
                  </div>
                </div>
                <div className="flex flex-wrap gap-2">
                  <button type="button" onClick={() => setFormData({...formData, workerType: 'alone', workerNames: []})} className={`text-xs px-3 py-1 rounded-full border ${formData.workerType === 'alone' ? 'bg-slate-900 text-white border-slate-900 shadow-sm' : 'bg-slate-50 text-slate-500'}`}>Sozinho</button>
                  {settings.employees.map(emp => (
                    <button key={emp} type="button" onClick={() => { setFormData({...formData, workerType: 'with_employees'}); toggleWorker(emp); }} className={`text-xs px-3 py-1 rounded-full border transition ${formData.workerNames.includes(emp) ? 'bg-emerald-500 text-white border-emerald-500 shadow-sm' : 'bg-slate-50 text-slate-500'}`}>
                      {emp}
                    </button>
                  ))}
                </div>
              </div>
              
              <div className="space-y-2">
                <label className="text-xs font-bold text-slate-500 uppercase">Outros Colaboradores (Inserﾃｧﾃ｣o Manual)</label>
                <input 
                  placeholder="Nomes separados por vﾃｭrgula..." 
                  className="w-full border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" 
                  value={formData.additionalWorkers} 
                  onChange={e => setFormData({...formData, additionalWorkers: e.target.value})}
                />
              </div>
            </div>

            <div className="space-y-2">
              <label className="text-xs font-bold text-slate-500 uppercase">Preﾃｧo</label>
              <div className="flex gap-2">
                <select className="flex-1 border border-slate-200 rounded-lg p-2 text-sm" value={formData.pricingType} onChange={e => setFormData({...formData, pricingType: e.target.value as PricingType})}>
                  <option value="hourly">竄ｬ / Hora</option>
                  <option value="fixed">Valor Fixo</option>
                </select>
                <input type="number" className="flex-1 border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value={formData.rate} onChange={e => setFormData({...formData, rate: Number(e.target.value)})} />
              </div>
            </div>
          </div>

          <div className="space-y-1 border-t pt-4">
            <label className="text-xs font-bold text-slate-500 uppercase">Notas Adicionais</label>
            <textarea 
              className="w-full border border-slate-200 rounded-lg p-3 text-sm min-h-[100px] focus:ring-2 focus:ring-emerald-500 outline-none" 
              placeholder="Adicione observaﾃｧﾃｵes sobre o jardim..." 
              value={formData.notes} 
              onChange={e => setFormData({ ...formData, notes: e.target.value })}
            ></textarea>
          </div>

          <button type="submit" className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-600/20 active:scale-[0.98] transition-transform">
            {formData.recurrence !== 'none' ? 'Registar Recorrﾃｪncia' : 'Registar Serviﾃｧo'}
          </button>
        </form>
      )}

      {/* SECﾃﾃグ DE OTIMIZAﾃﾃグ DE ROTA */}
      <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl shadow-xl border border-slate-700 space-y-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
              <i className="fas fa-route text-white"></i>
            </div>
            <div>
              <h3 className="text-white font-bold">Otimizador de Itinerﾃ｡rio</h3>
              <p className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">IA Geogrﾃ｡fica</p>
            </div>
          </div>
          <button 
            onClick={handleOptimizeRoute} 
            disabled={isOptimizing}
            className={`px-4 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${isOptimizing ? 'bg-slate-700 text-slate-500' : 'bg-emerald-600 text-white hover:bg-emerald-500 shadow-lg shadow-emerald-900/40 active:scale-95'}`}
          >
            {isOptimizing ? <i className="fas fa-spinner fa-spin mr-2"></i> : <i className="fas fa-magic mr-2"></i>}
            Otimizar Hoje
          </button>
        </div>

        {optimizedRoute && (
          <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700/50 animate-in fade-in slide-in-from-top-2">
            <p className="text-xs text-emerald-400 italic mb-4 leading-relaxed">"{optimizedRoute.explanation}"</p>
            <div className="space-y-3">
              {optimizedRoute.order.map((jobId, idx) => {
                const job = jobs.find(j => j.id === jobId);
                if (!job) return null;
                return (
                  <div key={job.id} className="flex items-center gap-4 group">
                    <div className="flex flex-col items-center">
                      <div className="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-[10px] font-black text-white shadow-sm">{idx + 1}</div>
                      {idx < optimizedRoute.order.length - 1 && <div className="w-0.5 h-6 bg-slate-700"></div>}
                    </div>
                    <div className="flex-1 bg-slate-700/30 p-3 rounded-xl border border-slate-700 flex justify-between items-center hover:bg-slate-700/50 transition">
                      <div className="flex flex-col">
                        <span className="text-sm font-bold text-slate-200">{job.clientName}</span>
                        <span className="text-[9px] text-slate-400 uppercase font-bold tracking-widest">{job.startTime}</span>
                      </div>
                      <a 
                        href={`https://www.google.com/maps/dir/?api=1&destination=${job.location?.lat},${job.location?.lng}`} 
                        target="_blank" 
                        className="text-emerald-400 hover:text-emerald-300 p-2"
                      >
                        <i className="fas fa-external-link-alt text-sm"></i>
                      </a>
                    </div>
                  </div>
                );
              })}
            </div>
            <button onClick={() => setOptimizedRoute(null)} className="mt-4 text-[10px] text-slate-500 font-bold uppercase hover:text-slate-300">Limpar Rota</button>
          </div>
        )}
      </div>

      {/* BARRA DE FILTROS */}
      <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm space-y-4">
        <div className="flex flex-col md:flex-row gap-4">
          <div className="flex-1 relative group">
            <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i className="fas fa-search text-slate-400 group-focus-within:text-emerald-500 transition-colors"></i>
            </div>
            <input
              type="text"
              placeholder="Procurar por cliente..."
              className="w-full bg-slate-50 border border-slate-200 rounded-xl py-2.5 pl-11 pr-4 text-sm focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none transition-all"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </div>
          
          <div className="w-full md:w-48">
            <select 
              className="w-full bg-slate-50 border border-slate-200 rounded-xl py-2.5 px-4 text-sm focus:border-emerald-500 outline-none transition-all cursor-pointer"
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value as any)}
            >
              <option value="all">套 Todos os Estados</option>
              <option value="scheduled">Agendados</option>
              <option value="pending">Em Curso</option>
              <option value="completed">Concluﾃｭdos</option>
            </select>
          </div>

          <div className="w-full md:w-48">
            <select 
              className="w-full bg-slate-50 border border-slate-200 rounded-xl py-2.5 px-4 text-sm focus:border-emerald-500 outline-none transition-all cursor-pointer"
              value={serviceTypeFilter}
              onChange={(e) => setServiceTypeFilter(e.target.value as any)}
            >
              <option value="all">諺 Todos os Tipos</option>
              <option value="regular">Manutenﾃｧﾃ｣o Regular</option>
              <option value="extra">Serviﾃｧo Extra</option>
            </select>
          </div>

          <div className="w-full md:w-48">
            <select 
              className="w-full bg-slate-50 border border-slate-200 rounded-xl py-2.5 px-4 text-sm focus:border-emerald-500 outline-none transition-all cursor-pointer"
              value={paymentFilter}
              onChange={(e) => setPaymentFilter(e.target.value as any)}
            >
              <option value="all">腸 Pagamentos (Todos)</option>
              <option value="paid">Pagos</option>
              <option value="unpaid">Em Dﾃｭvida</option>
            </select>
          </div>
        </div>
      </div>

      <div className="space-y-8">
        {['scheduled', 'pending', 'completed'].map(statusGroup => {
          if (statusFilter !== 'all' && statusFilter !== statusGroup) return null;

          const filtered = filteredJobs.filter(j => j.status === statusGroup);
          if (filtered.length === 0) return null;

          return (
            <div key={statusGroup} className="space-y-3">
              <h3 className="text-xs font-bold uppercase tracking-widest text-slate-400 flex items-center px-2">
                {statusGroup === 'scheduled' ? 'Prﾃｳximos' : statusGroup === 'pending' ? 'Em Curso' : 'Concluﾃｭdos'}
                <span className="ml-2 bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full text-[10px]">{filtered.length}</span>
              </h3>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {filtered.map(job => (
                  <div key={job.id} className={`bg-white p-5 rounded-2xl border ${job.paymentStatus === 'paid' ? 'border-emerald-100' : 'border-rose-50'} shadow-sm hover:shadow-md transition relative overflow-hidden group`}>
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <div className="flex items-center gap-2 mb-1">
                          <h4 className="font-bold text-slate-800">{job.clientName}</h4>
                          <span className={`text-[8px] font-black px-1.5 py-0.5 rounded uppercase ${job.serviceType === 'regular' ? 'bg-emerald-50 text-emerald-600' : 'bg-amber-50 text-amber-600'}`}>
                            {job.serviceType === 'regular' ? 'MANUTENﾃﾃグ' : 'EXTRA'}
                          </span>
                        </div>
                        <div className="text-[10px] text-slate-400 font-medium">
                          <i className="far fa-folder mr-1"></i> {job.category || 'Sem Categoria'} | <i className="far fa-calendar mr-1"></i> {job.date} | <i className="far fa-clock mr-1"></i> {job.startTime}-{job.endTime}
                        </div>
                        {job.workerNames && job.workerNames.length > 0 && (
                          <div className="text-[9px] text-emerald-600 font-black uppercase mt-2">
                            <i className="fas fa-users mr-1"></i> {job.workerNames.join(', ')}
                          </div>
                        )}
                      </div>
                      <div className="text-right">
                        <div className="text-sm font-bold text-slate-800">{job.totalValue.toFixed(2)}竄ｬ</div>
                      </div>
                    </div>

                    <div className="flex flex-wrap gap-1 mb-3">
                      {job.tasks.map(t => <span key={t} className="text-[9px] bg-slate-50 text-slate-500 px-2 py-1 rounded border border-slate-100">{t}</span>)}
                    </div>

                    <div className="flex items-center justify-between pt-4 border-t border-slate-50">
                      <div className="flex gap-2">
                        {job.status !== 'completed' && (
                          <button onClick={() => onUpdateStatus(job.id, 'completed')} className="text-[10px] bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-emerald-700 shadow-sm transition">Concluir</button>
                        )}
                        <button onClick={() => onUpdatePayment(job.id, job.paymentStatus === 'paid' ? 'unpaid' : 'paid')} className={`text-[10px] px-3 py-1.5 rounded-lg font-bold border transition ${job.paymentStatus === 'paid' ? 'border-rose-200 text-rose-600 hover:bg-rose-50' : 'border-emerald-200 text-emerald-600 hover:bg-emerald-50'}`}>
                          {job.paymentStatus === 'paid' ? 'Dﾃｭvida' : 'Pago'}
                        </button>
                        <a 
                          href={generateGoogleCalendarLink(job)} 
                          target="_blank" 
                          rel="noopener noreferrer" 
                          onClick={() => onUpdateSync(job.id)}
                          className={`text-[10px] px-3 py-1.5 rounded-lg font-bold transition ${job.syncedToCalendar ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' : 'bg-blue-600 text-white hover:bg-blue-700 shadow-sm'}`}
                        >
                          <i className="fab fa-google mr-1"></i> {job.syncedToCalendar ? 'Sincronizado' : 'Agenda'}
                        </a>
                      </div>
                      <button onClick={() => onDeleteJob(job.id)} className="text-slate-300 hover:text-rose-500 transition-colors p-2"><i className="fas fa-trash-alt"></i></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

export default JobLog;
